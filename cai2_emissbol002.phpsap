<?

include("fpdf151/pdf.php");
include("classes/db_orcfontesdes_classe.php");
include("classes/db_orcfontes_classe.php");
include("libs/db_liborcamento.php");
$clorcfontesdes = new cl_orcfontesdes;
$clorcfontes = new cl_orcfontes;

db_postmemory($HTTP_SERVER_VARS);

$seleciona_conta = '';
$descr_conta = 'TOTAS AS CONTAS';
$ano = db_getsession("DB_anousu");
$instit = db_getsession("DB_instit");
if($conta != 0) {
  $seleciona_conta = ' and corrente.k12_conta = '.$conta;
  $sql = 'select * from saltes where k13_conta = '.$conta;
  $result = pg_exec($sql);
  db_fieldsmemory($result,0);
  $descr_conta = "CONTA : ".$conta.' - '.$k13_descr;
  $xconta = $conta;
}else{
  $xconta = 'k13_conta';

}  

$selecao = 'TODOS OS CAIXAS';
$seleciona = '';
if ( $caixa != 0 ){
   $seleciona = ' and corrente.k12_id = '.$caixa;
   $sql = "select * from cfautent where k11_id = $caixa";
   $result = pg_exec($sql);
//   db_criatabela($result);exit;
   db_fieldsmemory($result,0);
   $selecao = "CAIXA : ".$caixa.' - '.$k11_local;
   $ip = "'".$k11_ipterm."'";
}else{
   $ip = 'null';
}
/*
if($datai == $dataf){
  $sql = "select k12_data 
          from boletim";

  $head1 = "BOLETIM DA TESOURARIA";
  $head3 = "BOLETIM NÚMERO: ".@$numbol;
  $head5 = "DATA : ".@$datai;
  
}else{
  */

////  RECEITAS 
$sql = " select c60_codsis,k12_conta,k12_receit,tabrec.k02_tipo,tabrec.k02_drecei,cornump.k12_valor 
         from corrente
              inner join cornump  on corrente.k12_id      = cornump.k12_id     
				 and corrente.k12_data   = cornump.k12_data   
				 and corrente.k12_autent = cornump.k12_autent 
              inner join tabrec  on k12_receit = k02_codigo 
	      inner join conplanoexe on k12_conta = c62_reduz
	                            and c62_anousu = ".db_getsession('DB_anousu')."
	      inner join conplanoreduz on c62_reduz = c61_reduz
	      inner join conplano on c60_codcon = c61_codcon
         where corrente.k12_data  = '".$datai."' $seleciona_conta $seleciona 
	 order by k02_tipo";
$resultorcamentaria = pg_query($sql);
//echo ' Receitas Orcamentaria ';
//db_criatabela($resultorcamentaria);

//// DESPESA EXTRA-ORCAMENTARIA E MOVIMENTAÇÕES BANCARIAS
$sql = "
select  
       k12_id,
       k12_autent,
       k12_data,
       k12_valor,
       tipo,
       entrou as debito,
       f.c60_descr as descr_debito,
       f.c60_codsis as sis_debito,
       saiu as credito,
       h.c60_descr as descr_credito,
       h.c60_codsis as sis_credito
from 
(select 
       k12_id,
       k12_autent,
       k12_data,
       k12_valor,
       tipo,
       corlanc as entrou,
       corrente as saiu
from 
    (select *, case when coalesce(corl_saltes,0) = 0 
                   then 'desp'
	           else 'tran'
	    	     end as tipo
    from 
        (select corrente.k12_id,
                corrente.k12_autent,
                corrente.k12_data,
                corrente.k12_valor,
                corrente.k12_conta as corrente,
                c.k13_conta as corr_saltes,
                b.k12_conta as corlanc,
                d.k13_conta as corl_saltes
         from corrente  
              inner join corlanc b on corrente.k12_id = b.k12_id 
                                  and corrente.k12_autent=b.k12_autent 
		           	  and corrente.k12_data = b.k12_data
              left join saltes c   on c.k13_conta = corrente.k12_conta
              left join saltes d   on d.k13_conta = b.k12_conta
	 where corrente.k12_data = '$datai' $seleciona_conta $seleciona ) as x) as xx) as xxx
    inner join conplanoexe   e on entrou = e.c62_reduz
                              and e.c62_anousu = ".db_getsession('DB_anousu')."
    inner join conplanoreduz i on e.c62_reduz = i.c61_reduz
    inner join conplano      f on i.c61_codcon = f.c60_codcon
    inner join conplanoexe   g on saiu = g.c62_reduz
                              and g.c62_anousu = ".db_getsession('DB_anousu')."
    inner join conplanoreduz j on g.c62_reduz = j.c61_reduz
    inner join conplano      h on j.c61_codcon = h.c60_codcon
    "
;
$resultdespesaextra = pg_query($sql);
//echo ' Despesa Extra-Orçamentaria ';
//db_criatabela($resultdespesaextra);

/// CONTAS MOVIMENTO
$sql ="	select k13_reduz,
               k13_descr,
               c60_estrut,
               c60_codsis,
	       c63_conta,
	       substr(fc_saltessaldo,2,13)::float8 as anterior,
	       substr(fc_saltessaldo,15,13)::float8 as debitado ,
	       substr(fc_saltessaldo,28,13)::float8 as creditado,
	       substr(fc_saltessaldo,41,13)::float8 as atual
	from (
 	      select k13_reduz,
 	             k13_descr,
	             c60_estrut,
		     c60_codsis,
		     c63_conta,
	             fc_saltessaldo(k13_reduz,'".$datai."','".$datai."',$ip)
	      from   saltes
	             inner join conplanoexe   on k13_reduz = c62_reduz
		                             and c62_anousu = ".db_getsession('DB_anousu')."
		     inner join conplanoreduz on c62_reduz = c61_reduz
	             inner join conplano      on c60_codcon = c61_codcon
	             left  join conplanoconta on c60_codcon = c63_codcon
	      order by c63_banco,c60_descr) as x
	      ";
//echo $sql;exit;
$resultcontasmovimento = pg_query($sql);
//db_criatabela($resultcontasmovimento);exit;



///DESPESAS ORCAMENTARIAS

$sql = " 
         select c60_codsis,
	        corrente.k12_conta,
	        c60_descr,
		case when corrente.k12_estorn = 'f' then sum(k12_valor) else 0 end as valor,
		case when corrente.k12_estorn = 't' then sum(k12_valor) else 0 end as estorno
         from corrente  
              inner join coremp b       on corrente.k12_autent = b.k12_autent 
                                       and corrente.k12_id = b.k12_id 
		 	               and corrente.k12_data = b.k12_data
	      left join corlanc c       on c.k12_autent = b.k12_autent
	                               and c.k12_id = b.k12_id
			               and c.k12_data = b.k12_data
              inner join empempenho e   on e60_numemp = b.k12_empen
	      inner join conplanoreduz on c61_reduz = corrente.k12_conta
	      inner join conplano on c61_codcon = c60_codcon
         where c.k12_codigo <> 0 and e.e60_anousu <> ".db_getsession("DB_anousu")." and corrente.k12_data = '$datai' $seleciona_conta $seleciona 
	 group by c60_codsis,corrente.k12_conta,c60_descr,k12_estorn
	 order by c60_codsis,corrente.k12_conta
       ";

//echo $sql;       
$resultdespesaorca = pg_query($sql);
//db_criatabela($resultdespesaorca);

$head2= "BOLETIM DE CAIXA E DE BANCOS";
//}
$head4 = $selecao;
$head6 = $descr_conta;
$pdf = new PDF();
$pdf->Open();
$pdf->AliasNbPages();
$pdf->AddPage();

//RECEITAS RECEBIDAS NO CAIXA
$numlin = pg_numrows($resultorcamentaria);
$cai_rec_orc = 0;
$cai_rec_ext = 0;
for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultorcamentaria,$i);
//   if($c60_codsis == 5){
     if($k02_tipo == 'O'){
       $cai_rec_orc += $k12_valor;
     }elseif($k02_tipo == 'E'){
       $cai_rec_ext += $k12_valor;
     }
// }
}


//DESPESAS ORÇAMENTARIAS PAGAS NO CAIXA
//db_criatabela($resultdespesaorca);
$numlin = pg_numrows($resultdespesaorca);
$cai_desp_orca = 0;
$cai_ret_bco_orca  = 0;
$cai_dep_bco_orca  = 0;
for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultdespesaorca,$i);
//   if($c60_codsis == 5){
     $cai_desp_orca += $valor + $estorno;
//   }
}

//DESPESAS EXTRA-ORÇAMENTARIAS PAGAS NO CAIXA
$numlin = pg_numrows($resultdespesaextra);
$cai_desp_ext = 0;
$cai_ret_bco  = 0;
$cai_dep_bco  = 0;
for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultdespesaextra,$i);
//   if($sis_credito == 5 || $sis_debito == 5){
     if($tipo == 'desp'){
       $cai_desp_ext += $k12_valor;
     }else{
       if($sis_debito == 5){
         $cai_ret_bco  += $k12_valor;
       }else{
         $cai_dep_bco  += $k12_valor;
       }
//     }
   }
}

//echo $cai_desp_ext;
/// SALDOS DO CAIXA
$caixa_saldo_anterior  = 0;
$caixa_debitado        = 0;
$caixa_creditado       = 0;
$caixa_saldo_atual     = 0;
$banco_saldo_anterior  = 0;
$banco_debitado        = 0;
$banco_creditado       = 0;
$banco_saldo_atual     = 0;
for($i = 0;$i < pg_numrows($resultcontasmovimento);$i++){
  db_fieldsmemory($resultcontasmovimento,$i);
  if($c60_codsis == 5){
    $caixa_saldo_anterior  += $anterior;
    $caixa_debitado        += $debitado;
    $caixa_creditado       += $creditado;
    $caixa_saldo_atual     += $atual;
  }else{
    $banco_saldo_anterior  += $anterior;
    $banco_debitado        += $debitado;
    $banco_creditado       += $creditado;
    $banco_saldo_atual     += $atual;
  }
}
/*
echo ' Contas Movimento  '."<br><br>";
echo ' caixa anterior   '.$caixa_saldo_anterior."<br>";
echo ' caixa debitado   '.$caixa_debitado."<br>";
echo ' caixa creditado  '.$caixa_creditado."<br>";
echo ' caixa atual      '.$caixa_saldo_atual."<br>";
echo ' bancos anterior  '.$banco_saldo_anterior."<br>";
echo ' bancos debitado  '.$banco_debitado."<br>";
echo ' bancos creditado '.$banco_creditado."<br>";
echo ' bancos atual     '.$banco_saldo_atual."<br>";
*/


$cai_tot_entradas = $cai_rec_orc  + $cai_rec_ext + $cai_ret_bco + $banco_creditado;
$cai_tot_saidas   = $cai_desp_ext + $cai_dep_bco + $cai_desp_orca + $cai_dep_bco_orca;
$saldo_seguinte = $cai_tot_entradas + $caixa_saldo_anterior - $cai_tot_saidas;
$alt = 5;
$pdf->SetFont('Arial','B',12);
//$pdf->SetTextColor(0,100,255);
$pdf->Setfillcolor(235);
$pdf->Cell(190,5,"BOLETIM DE CAIXA E DE BANCOS DE ".db_formatar($datai,'d'),0,1,"C",0);
$pdf->SetFont('Arial','B',10);
$pdf->ln(6);
$pdf->Cell(192,6,"MOVIMENTAÇÕES DO CAIXA",1,1,"L",0);
$pdf->SetFont('Arial','B',8);
$pdf->cell(48,$alt,'ENTRADAS (DÉBITO)',1,0,'C',0);
$pdf->cell(48,$alt,'VALORES',1,0,'C',0);
$pdf->cell(48,$alt,'SAÍDAS (CRÉDITO)',1,0,'C',0);
$pdf->cell(48,$alt,'VALORES',1,1,'C',0);
$pdf->SetTextColor(0);
$pdf->cell(48,$alt,'Receitas Orçamentárias',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_rec_orc,'f'),1,0,'R',0);
$pdf->cell(48,$alt,'Despesas Orçamentárias',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_desp_orca ,'f'),1,1,'R',0);
$pdf->cell(48,$alt,'Receitas Extra-Orçamentárias',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_rec_ext ,'f'),1,0,'R',0);
$pdf->cell(48,$alt,'Despesas Extra-Orçamentárias',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_desp_ext,'f'),1,1,'R',0);
$pdf->cell(48,$alt,'Retiradas de Bancos',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($banco_creditado,'f'),1,0,'R',0);
$pdf->cell(48,$alt,'Depósitos Bancários',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_dep_bco,'f'),1,1,'R',0);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(48,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_tot_entradas,'f'),1,0,'R',0);
$pdf->cell(48,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_tot_saidas,'f'),1,1,'R',0);
$pdf->SetTextColor(0,0,0);
$pdf->cell(48,$alt,'Saldo Anterior',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($caixa_saldo_anterior,'f'),1,0,'R',0);
$pdf->cell(48,$alt,'Saldo Seguinte',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($saldo_seguinte,'f'),1,1,'R',0);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(48,$alt,'SOMA',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($caixa_saldo_anterior + $cai_tot_entradas,'f'),1,0,'R',0);
$pdf->cell(48,$alt,'SOMA',1,0,'L',0);
$pdf->cell(48,$alt,db_formatar($cai_tot_saidas + $saldo_seguinte ,'f'),1,1,'R',0);

$pdf->ln(6);
//$pdf->SetTextColor(0,100,255);
$pdf->SetFont('Arial','B',10);
$pdf->Cell(192,6,"MOVIMENTAÇÕES BANCÁRIAS",1,1,"L",0);
$pdf->SetFont('Arial','B',7);
$pdf->cell(96,$alt,'BANCOS',"LRT",0,'C',0);
$pdf->cell(24,$alt,'SALDO',"LRT",0,'C',0);
$pdf->cell(24,$alt,'DÉBITOS',"LRT",0,'C',0);
$pdf->cell(24,$alt,'CRÉDITOS',"LRT",0,'C',0);
$pdf->cell(24,$alt,'SALDO',"LRT",1,'C',0);
$pdf->cell(96,$alt,'',"LRB",0,'C',0);
$pdf->cell(24,$alt,'ANTERIOR',"LRB",0,'C',0);
$pdf->cell(24,$alt,'DEPÓSITOS',"LRB",0,'C',0);
$pdf->cell(24,$alt,'RETIRADAS',"LRB",0,'C',0);
$pdf->cell(24,$alt,'ATUAL',"LRB",1,'C',0);
$pdf->SetTextColor(0);
$saldo_anterior  = 0;
$saldo_debitado  = 0;
$saldo_creditado = 0;
$saldo_atual     = 0;
$pdf->SetTextColor(0);
$pdf->SetFont('Arial','',6);
for($i = 0;$i < pg_numrows($resultcontasmovimento);$i++){
  db_fieldsmemory($resultcontasmovimento,$i);
  if($pdf->gety() > ($pdf->h - 30)){
    $pdf->addpage();
    $pdf->SetFont('Arial','B',10);
    $pdf->Cell(192,6,"MOVIMENTAÇÕES BANCÁRIAS",1,1,"L",0);
    $pdf->SetFont('Arial','B',7);
    $pdf->cell(96,$alt,'BANCOS',"LRT",0,'C',0);
    $pdf->cell(24,$alt,'SALDO',"LRT",0,'C',0);
    $pdf->cell(24,$alt,'DÉBITOS',"LRT",0,'C',0);
    $pdf->cell(24,$alt,'CRÉDITOS',"LRT",0,'C',0);
    $pdf->cell(24,$alt,'SALDO',"LRT",1,'C',0);
    $pdf->cell(96,$alt,'',"LRB",0,'C',0);
    $pdf->cell(24,$alt,'ANTERIOR',"LRB",0,'C',0);
    $pdf->cell(24,$alt,'DEPÓSITOS',"LRB",0,'C',0);
    $pdf->cell(24,$alt,'CREDITOS',"LRB",0,'C',0);
    $pdf->cell(24,$alt,'ATUAL',"LRB",1,'C',0);
    $pdf->SetFont('Arial','',6);

  }
  if($c60_codsis == 6){
    $pdf->cell(80,$alt,$k13_reduz.' - '.$k13_descr,"LTB",0,'L',0);
    $pdf->cell(16,$alt,$c63_conta,"RTB",0,'L',0);
    $pdf->cell(24,$alt,db_formatar($anterior,'f'),1,0,'R',0);
    $pdf->cell(24,$alt,db_formatar($debitado,'f'),1,0,'R',0);
    $pdf->cell(24,$alt,db_formatar($creditado,'f'),1,0,'R',0);
    $pdf->cell(24,$alt,db_formatar($atual,'f'),1,1,'R',0);
    $saldo_anterior  += $anterior;
    $saldo_debitado  += $debitado;
    $saldo_creditado += $creditado;
    $saldo_atual     += $atual;
  }
}
$pdf->SetFont('Arial','B',6);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(96,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(24,$alt,db_formatar($saldo_anterior,'f'),1,0,'R',0);
$pdf->cell(24,$alt,db_formatar($saldo_debitado,'f'),1,0,'R',0);
$pdf->cell(24,$alt,db_formatar($saldo_creditado,'f'),1,0,'R',0);
$pdf->cell(24,$alt,db_formatar($saldo_atual,'f'),1,1,'R',0);

$sql = 
/*
"
select debito,descr_debito,sum(caixa) as caixa,sum(banco) as banco
from
(select distinct
	debito,
        descr_debito,
        case when sis_credito = 5 then k12_valor else 0 end as caixa,
        case when sis_credito = 6 then k12_valor else 0 end as banco
from
	(select k12_id, 
       		k12_autent, 
       		k12_data, 
       		k12_valor, 
       		tipo, 
       		entrou as debito, 
       		f.c60_descr as descr_debito, 
       		f.c60_codsis as sis_debito, 
       		saiu as credito, 
       		h.c60_descr as descr_credito, 
       		h.c60_codsis as sis_credito 
	from 	(select k12_id, 
             		k12_autent, 
	     		k12_data, 
	     		k12_valor, 
	     		tipo, 
	     		corlanc as entrou, 
	     		corrente as saiu from 	(select *, case when coalesce(corl_saltes,0) = 0 
	                                           	      then 'desp' 
						              else 'tran' 
						                end as tipo 
				    		from 	(select corrente.k12_id, 
				                 	     corrente.k12_autent, 
						 	     corrente.k12_data, 
						 	     corrente.k12_valor, 
						 	     corrente.k12_conta as corrente, 
						 	     c.k13_conta as corr_saltes, 
						 	     b.k12_conta as corlanc, 
							     d.k13_conta as corl_saltes 
				          		from corrente  
					       			inner join corlanc b on corrente.k12_id = b.k12_id 
					                		            and corrente.k12_autent=b.k12_autent 
								   		    and corrente.k12_data = b.k12_data 
					       			left join saltes c   on c.k13_conta = corrente.k12_conta 
					       			left join saltes d   on d.k13_conta = b.k12_conta 
					  		where corrente.k12_data = '$datai' $seleciona_conta $seleciona ) 
				          		as x) 
	                            		as xx) 
      		as xxx 
      		inner join conplanoexe   e on entrou = e.c62_reduz 
		inner join conplanoreduz i on e.c62_reduz  = i.c61_reduz
      		inner join conplano      f on i.c61_codcon = f.c60_codcon 
      		inner join conplanoexe   g on saiu = g.c62_reduz
		inner join conplanoreduz j on g.c62_reduz = j.c61_reduz
      		inner join conplano      h on j.c61_codcon = h.c60_codcon)
	as xxxx
) as xxxxx
group by debito,descr_debito
*/
"
select k12_data,
       case when k12_estorn =  'f' then valor else 0 end as valor,
       case when k12_estorn <> 'f' then valor else 0 end as estorno,
       corrente,
       descr_conta,
       corr_saltes,
       corlanc,
       descr_receita,
       corl_saltes
from (
select corrente.k12_id,
       corrente.k12_data,
       sum(corrente.k12_valor) as valor,
       corrente.k12_conta as corrente,
       p2.c60_descr as descr_conta,
       c.k13_conta as corr_saltes,
       b.k12_conta as corlanc,
       p1.c60_descr as descr_receita,
       coalesce(d.k13_conta,0) as corl_saltes,
       k12_estorn
from corrente
     inner join corlanc b on corrente.k12_id = b.k12_id
                          and corrente.k12_autent=b.k12_autent
                          and corrente.k12_data = b.k12_data
     left join saltes c   on c.k13_conta = corrente.k12_conta
     left join saltes d   on d.k13_conta = b.k12_conta
     inner join conplanoreduz r1 on b.k12_conta = r1.c61_reduz
     inner join conplano      p1 on r1.c61_codcon = p1.c60_codcon
     inner join conplanoreduz r2 on corrente.k12_conta = r2.c61_reduz
     inner join conplano      p2 on r2.c61_codcon = p2.c60_codcon
where corrente.k12_data = '$datai' $seleciona_conta $seleciona
group by corrente.k12_id,
       corrente.k12_data,
       corrente.k12_conta,
       p2.c60_descr,
       c.k13_conta,
       b.k12_conta,
       p1.c60_descr,
       d.k13_conta,
       k12_estorn
order by corrente.k12_conta,
         p2.c60_descr,
	 b.k12_conta,
	 p1.c60_descr
) as x
    "
;
//echo $sql;exit;
$resultdespesaextra = pg_query($sql);
//db_criatabela($resultdespesaextra);

$pdf->SetFont('Arial','B',10);
$pdf->Cell(192,6,"",0,1,"L",0);
$pdf->Cell(192,6,"TRANSFËNCIAS BANCÁRIAS",1,1,"L",0);
$pdf->SetFont('Arial','B',7);
$pdf->cell(112,$alt,'DESCRIÇÃO',1,0,'C',0);
$pdf->cell(20,$alt,'VALOR',1,0,'C',0);
$pdf->cell(20,$alt,'ESTORNO',1,0,'C',0);
$pdf->cell(20,$alt,'TOTAL',1,0,'C',0);
$pdf->cell(20,$alt,'BANCO',1,1,'C',0);
$pdf->SetTextColor(0);
$saldo_anterior  = 0;
$saldo_debitado  = 0;
$saldo_creditado = 0;
$saldo_atual     = 0;
$pdf->SetFont('Arial','',6);




// TRANSFERENCIAS

$numlin = pg_numrows($resultdespesaextra);
$total_valor   = 0;
$total_estorno = 0;
$total_banco   = 0;
$quebra = 0;

for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultdespesaextra,$i);

   $sql = "select k13_conta
           from saltes where k13_conta = $corr_saltes
	   union all
	   select k13_conta
	   from saltes where k13_conta = $corl_saltes";
   $result = pg_exec($sql);
   if($result==false || pg_numrows($result)!=2)
     continue;
   
   if($quebra != $corrente){
      $pdf->SetFont('Arial','B',8);
      $pdf->cell(10,$alt,$corrente,"LTB",0,"R",0); 
      $pdf->cell(102,$alt,'- '.$descr_conta,"RTB",0,"L",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,1,"R",0); 
      $quebra = $corrente;
      $pdf->SetFont('Arial','',6);
   }
   $pdf->cell(10,$alt,$corlanc,"LTB",0,"R",0); 
   $pdf->cell(102,$alt,'- '.$descr_receita,"RTB",0,"L",0); 
   $pdf->cell(20,$alt,db_formatar($valor,'f'),1,0,"R",0); 
   $pdf->cell(20,$alt,db_formatar($estorno,'f'),1,0,"R",0); 
   $pdf->cell(20,$alt,db_formatar($valor + $estorno,'f'),1,0,"R",0); 
   $total_banco   += $valor + $estorno;
   if( $i+1 == $numlin ){ 
     $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
     $total_banco = 0;
   }elseif($quebra != pg_result($resultdespesaextra,$i+1,"corrente") ){
     $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
     $total_banco = 0;
   }else{
     $pdf->cell(20,$alt,db_formatar(0,'f'),1,1,"R",0); 
   }
   $total_valor   += $valor;
   $total_estorno += $estorno;
}


$pdf->SetFont('Arial','B',6);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(112,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(20,$alt,db_formatar($total_valor,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_valor + $total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_valor + $total_estorno,'f'),1,1,'R',0);
$pdf->SetTextColor(0);







//RECEITAS ORÇAMENTÁRIAS

$pdf->SetTextColor(0);
$pdf->addpage();
//$pdf->SetTextColor(0,100,255);
$pdf->SetFont('Arial','B',10);
$pdf->Cell(192,6,"RECEITAS ORÇAMENTÁRIAS",1,1,"L",0);
$pdf->SetFont('Arial','B',7);
$pdf->cell(112,$alt,'DESCRIÇÃO',1,0,'C',0);
$pdf->cell(20,$alt,'VALOR',1,0,'C',0);
$pdf->cell(20,$alt,'ESTORNO',1,0,'C',0);
$pdf->cell(20,$alt,'TOTAL',1,0,'C',0);
$pdf->cell(20,$alt,'TOTAL CONTA',1,1,'C',0);
$pdf->SetTextColor(0);
$saldo_anterior  = 0;
$saldo_debitado  = 0;
$saldo_creditado = 0;
$saldo_atual     = 0;
$pdf->SetTextColor(0);
$pdf->SetFont('Arial','b',6);

$sql ="

select k12_conta,
       c60_descr,
       k12_receit,
       k02_tipo,
       k02_drecei,
       sum(case when k12_estorn = 'f' then valor else 0 end) as valor,
       sum(case when k12_estorn = 't' then valor else 0 end) as estorno
from 
(select c60_codsis, 
       k12_estorn,
       k12_conta,
       c60_descr,
       k12_receit,
       tabrec.k02_tipo,
       tabrec.k02_drecei,
       sum(corrente.k12_valor) as valor
from corrente
     inner join cornump       on corrente.k12_id     = cornump.k12_id
                             and corrente.k12_data   = cornump.k12_data
                             and corrente.k12_autent = cornump.k12_autent
     inner  join tabrec       on k12_receit = k02_codigo
     left   join taborc       on tabrec.k02_codigo = taborc.k02_codigo
     left   join orcfontes    on k02_estorc = o57_fonte
     inner join conplanoexe   on c62_reduz = corrente.k12_conta
                             and c62_anousu = ".db_getsession('DB_anousu')."
     inner join conplanoreduz on c62_reduz = c61_reduz 
     inner join conplano on c60_codcon = c61_codcon
where k02_anousu = ".db_getsession('DB_anousu')." and corrente.k12_data  = '$datai' $seleciona_conta $seleciona
group by c60_codsis,
         k12_estorn,
         k12_conta,
	 c60_descr,
         k12_receit,
         tabrec.k02_tipo,
         tabrec.k02_drecei) as x
group by k12_conta,
       c60_descr,
       k12_receit,
       k02_tipo,
       k02_drecei
order by k12_conta,c60_descr,k12_receit;

";
//echo $sql;exit;
$resultreceitas = pg_query($sql);
//db_criatabela($resultreceitas);
$numlin = pg_numrows($resultreceitas);
$total_valor   = 0;
$total_estorno = 0;
$quebra = 0;
$total_banco = 0;
$total_geral = 0;
for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultreceitas,$i);
   if($quebra != $k12_conta){
      $pdf->SetFont('Arial','B',8);
      $pdf->cell(10,$alt,$k12_conta,"LTB",0,"R",0); 
      $pdf->cell(102,$alt,'- '.$c60_descr,"RTB",0,"L",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,1,"R",0); 
      $quebra = $k12_conta;
      $pdf->SetFont('Arial','',6);
   }
   
   if($k02_tipo == 'O'){
     $pdf->cell(10,$alt,$k12_receit,"LTB",0,"R",0); 
     $pdf->cell(102,$alt,'- '.$k02_drecei,"RTB",0,"L",0); 
     $pdf->cell(20,$alt,db_formatar($valor,'f'),1,0,"R",0); 
     $pdf->cell(20,$alt,db_formatar($estorno,'f'),1,0,"R",0); 
     $pdf->cell(20,$alt,db_formatar($valor + $estorno,'f'),1,0,"R",0); 
     $total_valor   += $valor;
     $total_estorno += $estorno;
     $total_banco   += $valor + $estorno;
     $total_geral   += $valor + $estorno;
     if( $i+1 == $numlin ){ 
       $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
       $total_banco = 0;
     }elseif($quebra != pg_result($resultreceitas,$i+1,"k12_conta") ){
       $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
       $total_banco = 0;
     }else{
       $pdf->cell(20,$alt,db_formatar(0,'f'),1,1,"R",0); 
     }
   }
}


$pdf->SetFont('Arial','B',6);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(112,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(20,$alt,db_formatar($total_valor,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar(0,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_valor + $total_estorno,'f'),1,1,'R',0);


//RECEITAS EXTRA-ORÇAMENTÁRIAS
$pdf->SetTextColor(0);
$pdf->addpage();
//$pdf->SetTextColor(0,100,255);
$pdf->SetFont('Arial','B',10);
$pdf->Cell(192,6,"RECEITAS EXTRA-ORÇAMENTÁRIAS",1,1,"L",0);
$pdf->SetFont('Arial','B',7);
$pdf->cell(87,$alt,'DESCRIÇÃO',1,0,'C',0);
$pdf->cell(35,$alt,'CAIXA',1,0,'C',0);
$pdf->cell(35,$alt,'BANCOS',1,0,'C',0);
$pdf->cell(35,$alt,'TOTAL',1,1,'C',0);
$pdf->SetTextColor(0);
$pdf->SetFont('Arial','',6);
//$resultreceitas = pg_query($sql);
$numlin = pg_numrows($resultreceitas);
$total_cai_rec_ext = 0;
$total_bco_rec_ext = 0;
//db_criatabela($resultreceitas);
for($ix = 0; $ix < $numlin;$ix++){
   db_fieldsmemory($resultreceitas,$ix);
   if($k02_tipo == 'E'){
     $pdf->cell(10,$alt,$k12_receit,"LTB",0,"R",0); 
     $pdf->cell(77,$alt,'- '.$k02_drecei,"RTB",0,"L",0); 
     $pdf->cell(35,$alt,db_formatar($caixa,'f'),1,0,"R",0); 
     $pdf->cell(35,$alt,db_formatar($banco,'f'),1,0,"R",0); 
     $pdf->cell(35,$alt,db_formatar($caixa + $banco,'f'),1,1,"R",0); 
     $total_cai_rec_ext += $caixa;
     $total_bco_rec_ext += $banco;
   }
}


$pdf->SetFont('Arial','B',6);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(87,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(35,$alt,db_formatar($total_cai_rec_ext,'f'),1,0,'R',0);
$pdf->cell(35,$alt,db_formatar($total_bco_rec_ext,'f'),1,0,'R',0);
$pdf->cell(35,$alt,db_formatar($total_cai_rec_ext + $total_bco_rec_ext,'f'),1,1,'R',0);



//DESPESAS ORÇAMENTÁRIAS

$pdf->SetTextColor(0);
$pdf->addpage();
//$pdf->SetTextColor(0,100,255);
$pdf->SetFont('Arial','B',10);
$pdf->Cell(192,6,"DESPESAS ORÇAMENTÁRIAS",1,1,"L",0);
$pdf->SetFont('Arial','B',7);
$pdf->cell(112,$alt,'DESCRIÇÃO',1,0,'C',0);
$pdf->cell(20,$alt,'VALOR',1,0,'C',0);
$pdf->cell(20,$alt,'ESTORNO',1,0,'C',0);
$pdf->cell(20,$alt,'TOTAL',1,0,'C',0);
$pdf->cell(20,$alt,'TOTAL CONTA',1,1,'C',0);
$pdf->SetTextColor(0);
$pdf->SetFont('Arial','',6);
$numlin = pg_numrows($resultdespesaorca);
$total_valor   = 0;
$total_estorno = 0;
$total_banco   = 0;

for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultdespesaorca,$i);
   $pdf->cell(10,$alt,$k12_conta,"LTB",0,"R",0); 
   $pdf->cell(102,$alt,'- '.$c60_descr,"TB",0,"L",0); 
   $pdf->cell(20,$alt,db_formatar($valor,'f'),1,0,"R",0); 
   $pdf->cell(20,$alt,db_formatar($estorno,'f'),1,0,"R",0); 
   $pdf->cell(20,$alt,db_formatar($valor + $estorno,'f'),1,0,"R",0); 
   $total_valor   += $valor;
   $total_estorno += $estorno;
   /*
   $total_banco   += $valor + $estorno;
   if( $i+1 == $numlin ){ 
     $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
     $total_banco = 0;
   }elseif($quebra != pg_result($resultdespesaorca,$i+1,"corrente") ){
     $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
     $total_banco = 0;
   }else{*/
     $pdf->cell(20,$alt,db_formatar(0,'f'),1,1,"R",0); 
   //}
}


$pdf->SetFont('Arial','B',6);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(112,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(20,$alt,db_formatar($total_valor,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_valor + $total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar(0,'f'),1,1,'R',0);
$pdf->SetTextColor(0);


//DESPESAS EXTRA-ORÇAMENTÁRIAS

$pdf->addpage();
//$pdf->SetTextColor(0,100,255);
$pdf->SetFont('Arial','B',10);
$pdf->Cell(192,6,"DESPESAS EXTRA-ORÇAMENTÁRIAS",1,1,"L",0);
$pdf->SetFont('Arial','B',7);
$pdf->cell(112,$alt,'DESCRIÇÃO',1,0,'C',0);
$pdf->cell(20,$alt,'VALOR',1,0,'C',0);
$pdf->cell(20,$alt,'ESTORNO',1,0,'C',0);
$pdf->cell(20,$alt,'TOTAL',1,0,'C',0);
$pdf->cell(20,$alt,'BANCO',1,1,'C',0);
$pdf->SetTextColor(0);
$saldo_anterior  = 0;
$saldo_debitado  = 0;
$saldo_creditado = 0;
$saldo_atual     = 0;
$pdf->SetFont('Arial','',6);

//echo 'Despesa Extra-Orçamentaria';
//db_criatabela($resultdespesaextra);

$numlin = pg_numrows($resultdespesaextra);
$total_valor   = 0;
$total_estorno = 0;
$total_banco   = 0;
$quebra = 0;

for($i = 0; $i < $numlin;$i++){
   db_fieldsmemory($resultdespesaextra,$i);

   $sql = "select k13_conta
           from saltes where k13_conta = $corr_saltes
	   union all
	   select k13_conta
	   from saltes where k13_conta = $corl_saltes";
   $result = pg_exec($sql);
   if($result==false || pg_numrows($result)==2)
     continue;
   

   
   if($quebra != $corrente){
      $pdf->SetFont('Arial','B',8);
      $pdf->cell(10,$alt,$corrente,"LTB",0,"R",0); 
      $pdf->cell(102,$alt,'- '.$descr_conta,"RTB",0,"L",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,0,"R",0); 
      $pdf->cell(20,$alt,'',1,1,"R",0); 
      $quebra = $corrente;
      $pdf->SetFont('Arial','',6);
   }
   $pdf->cell(10,$alt,$corlanc,"LTB",0,"R",0); 
   $pdf->cell(102,$alt,'- '.$descr_receita,"RTB",0,"L",0); 
   $pdf->cell(20,$alt,db_formatar($valor,'f'),1,0,"R",0); 
   $pdf->cell(20,$alt,db_formatar($estorno,'f'),1,0,"R",0); 
   $pdf->cell(20,$alt,db_formatar($valor + $estorno,'f'),1,0,"R",0); 
   $total_banco   += $valor + $estorno;
   if( $i+1 == $numlin ){ 
     $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
     $total_banco = 0;
   }elseif($quebra != pg_result($resultdespesaextra,$i+1,"corrente") ){
     $pdf->cell(20,$alt,db_formatar($total_banco,'f'),1,1,"R",0);
     $total_banco = 0;
   }else{
     $pdf->cell(20,$alt,db_formatar(0,'f'),1,1,"R",0); 
   }
   $total_valor   += $valor;
   $total_estorno += $estorno;
}


$pdf->SetFont('Arial','B',6);
//$pdf->SetTextColor(0,100,255);
$pdf->cell(112,$alt,'TOTAL',1,0,'L',0);
$pdf->cell(20,$alt,db_formatar($total_valor,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_valor + $total_estorno,'f'),1,0,'R',0);
$pdf->cell(20,$alt,db_formatar($total_valor + $total_estorno,'f'),1,1,'R',0);
$pdf->SetTextColor(0);

$pdf->Output();
?>
